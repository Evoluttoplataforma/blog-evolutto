---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import '../../styles/home.css';

export async function getStaticPaths() {
  const articles = await getCollection('blog');
  const categories = [...new Set(articles.flatMap(a => a.data.categories || []))];

  return categories.map(category => ({
    params: { name: category.toLowerCase() },
    props: { categoryName: category },
  }));
}

const { categoryName } = Astro.props;
const normalizedName = Astro.params.name;

const allArticles = await getCollection('blog');

const articles = allArticles
  .filter(a => a.data.categories?.some(c => c.toLowerCase() === normalizedName))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Get all categories for sidebar
const allCategories = [...new Set(allArticles.flatMap(a => a.data.categories || []))];

const categoryLabels: Record<string, string> = {
  digitalizacao: 'Digitalizacao',
  consultoria: 'Consultoria',
  marketing: 'Marketing',
  vendas: 'Vendas',
  tecnologia: 'Tecnologia',
  gestao: 'Gestao',
  produtividade: 'Produtividade',
  inovacao: 'Inovacao',
  cases: 'Cases de Sucesso',
  geral: 'Geral',
  escala: 'Escala',
};

const displayName = categoryLabels[normalizedName] || categoryName.charAt(0).toUpperCase() + categoryName.slice(1);
---

<BaseLayout title={`${displayName} - Evolutto Blog`} description={`Artigos sobre ${displayName} para consultores e empresas.`}>
  <section class="category-page">
    <div class="container">
      <!-- Category Header -->
      <header class="category-header">
        <a href="/" class="back-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          Voltar ao Blog
        </a>
        <h1 class="category-title">{displayName}</h1>
        <p class="category-description">{articles.length} artigos encontrados</p>
      </header>

      <!-- Articles Grid -->
      <div class="category-layout">
        <main class="category-main">
          {articles.length > 0 ? (
            <div class="articles-grid">
              {articles.map((article) => (
                <ArticleCard article={article} />
              ))}
            </div>
          ) : (
            <div class="no-articles">
              <p>Nenhum artigo encontrado nesta categoria.</p>
              <a href="/" class="btn btn-primary">Ver todos os artigos</a>
            </div>
          )}
        </main>

        <!-- Sidebar -->
        <aside class="category-sidebar">
          <div class="sidebar-widget">
            <h4 class="widget-title">Categorias</h4>
            <ul class="category-list">
              {allCategories.slice(0, 10).map((cat) => (
                <li>
                  <a
                    href={`/category/${cat.toLowerCase()}`}
                    class:list={['category-link', { active: cat.toLowerCase() === normalizedName }]}
                  >
                    <span>{categoryLabels[cat.toLowerCase()] || cat}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .category-page {
    padding-top: 120px;
    padding-bottom: 80px;
    min-height: 70vh;
  }

  .category-header {
    margin-bottom: 3rem;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    transition: var(--transition);
    margin-bottom: 1.5rem;
  }

  .back-link:hover {
    color: var(--primary);
    gap: 12px;
  }

  .category-title {
    font-size: 3rem;
    font-weight: 800;
    color: var(--text-main);
    margin-bottom: 0.5rem;
    letter-spacing: -1px;
  }

  .category-description {
    font-size: 1.1rem;
    color: var(--text-muted);
  }

  .category-layout {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 3rem;
  }

  .category-main {
    min-width: 0;
  }

  .category-sidebar {
    position: sticky;
    top: 120px;
    align-self: start;
  }

  .no-articles {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--bg-subtle);
    border-radius: var(--radius-lg);
  }

  .no-articles p {
    color: var(--text-muted);
    margin-bottom: 1.5rem;
  }

  .category-link.active {
    color: var(--primary);
    font-weight: 700;
  }

  @media (max-width: 1024px) {
    .category-layout {
      grid-template-columns: 1fr;
    }

    .category-sidebar {
      position: relative;
      top: 0;
      order: 1;
    }
  }

  @media (max-width: 768px) {
    .category-page {
      padding-top: 100px;
    }

    .category-title {
      font-size: 2rem;
    }
  }
</style>
